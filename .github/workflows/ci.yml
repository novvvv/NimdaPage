name: CI Pipeline

on:
  push:
    branches: [ main, develop, be ]  # 이 브랜치들에 코드를 푸시하면 실행
  pull_request:
    branches: [ main, develop ]      # PR을 보낼 때도 실행

# 작업들 정의
jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest  # Ubuntu 서버에서 실행
    
    steps:
      # 1단계: 코드 가져오기
      - name: Checkout code
        uses: actions/checkout@v4
        # GitHub 저장소의 코드를 가져옵니다
        
      # 2단계: Java 17 설치
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # 프로젝트가 Java 17을 사용하므로 설치합니다
          
      # 3단계: Maven 의존성 캐싱 (빌드 속도 향상)
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          # Maven 라이브러리를 캐시해서 다음 빌드가 더 빠릅니다
          
      # 4단계: Maven으로 빌드 및 테스트
      - name: Build with Maven
        working-directory: NimdaConBackEnd/backend-spring
        run: mvn clean package -DskipTests
        # clean: 이전 빌드 파일 삭제
        # package: JAR 파일 생성
        # -DskipTests: 테스트는 건너뛰고 빌드만 (테스트가 없으면 실패할 수 있어서)
        
      # 5단계: 테스트 실행 (선택사항 - 테스트가 있다면)
      - name: Run tests
        working-directory: NimdaConBackEnd/backend-spring
        run: mvn test
        continue-on-error: true
        # continue-on-error: 테스트가 없어도 실패하지 않음
        # 테스트가 추가되면 이 단계가 자동으로 실행됩니다
        
      # 6단계: 빌드 결과물(JAR) 저장
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-file
          path: NimdaConBackEnd/backend-spring/target/*.jar
          retention-days: 7
          # 빌드된 JAR 파일을 저장해두면 나중에 다운로드 가능합니다

