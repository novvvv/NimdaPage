name: CI Pipeline

on:
  push:
    branches: [ main, develop, be ]  # 이 브랜치들에 코드를 푸시하면 실행
  pull_request:
    branches: [ main, develop ]      # PR을 보낼 때도 실행

# 작업들 정의
jobs:
  build:
    name: Build and Test
    runs-on: ubuntu-latest  # Ubuntu 서버에서 실행
    
    steps:
      # 1단계: 코드 가져오기
      - name: Checkout code
        uses: actions/checkout@v4
        # GitHub 저장소의 코드를 가져옵니다
        
      # 2단계: Java 17 설치
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          # 프로젝트가 Java 17을 사용하므로 설치합니다
          
      # 3단계: Maven 의존성 캐싱 (빌드 속도 향상)
      - name: Cache Maven dependencies
        uses: actions/cache@v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
          restore-keys: ${{ runner.os }}-m2
          # Maven 라이브러리를 캐시해서 다음 빌드가 더 빠릅니다
          
      # 4단계: Maven으로 빌드 및 테스트
      - name: Build with Maven
        working-directory: NimdaConBackEnd/backend-spring
        run: mvn clean package -DskipTests
        # clean: 이전 빌드 파일 삭제
        # package: JAR 파일 생성
        # -DskipTests: 테스트는 건너뛰고 빌드만 (테스트가 없으면 실패할 수 있어서)
        
      # 5단계: 테스트 실행 (선택사항 - 테스트가 있다면)
      - name: Run tests
        working-directory: NimdaConBackEnd/backend-spring
        run: mvn test
        continue-on-error: true
        # continue-on-error: 테스트가 없어도 실패하지 않음
        # 테스트가 추가되면 이 단계가 자동으로 실행됩니다
        
      # 6단계: 빌드 결과물(JAR) 저장
      - name: Upload JAR artifact
        uses: actions/upload-artifact@v4
        with:
          name: jar-file
          path: NimdaConBackEnd/backend-spring/target/*.jar
          retention-days: 7
          # 빌드된 JAR 파일을 저장해두면 나중에 다운로드 가능합니다
          
      # 7단계: Docker 이미지 빌드
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        # Docker 빌드를 위한 최적화된 빌드 환경 설정
        
      # 8단계: Docker 이미지 빌드
      - name: Build Docker image
        run: |
          docker build -t novvvv/nimda-backend:latest .
          # Dockerfile을 사용하여 Docker 이미지를 빌드합니다
          # JAR 파일은 이미 빌드되어 있어서 Dockerfile에서 복사됩니다
          
      # 9단계: Docker Hub에 로그인
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}
          # GitHub Secrets에 저장된 Docker Hub 인증 정보 사용
          # Secrets 설정: 저장소 Settings → Secrets and variables → Actions
          
      # 10단계: Docker 이미지를 Docker Hub에 푸시
      - name: Push Docker image
        run: docker push novvvv/nimda-backend:latest
        # 빌드된 Docker 이미지를 Docker Hub에 업로드합니다
        # docker-compose.yml에서 이 이미지를 사용합니다
        
      # 11단계: 서버에 SSH로 접속하여 배포
      - name: Deploy to server
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} "cd ${{ secrets.SERVER_DEPLOY_PATH }} && pwd && docker-compose pull && docker-compose up -d && docker system prune -f || true"
        # Secrets 설정 필요:
        # - SERVER_HOST: 서버 IP 주소 또는 도메인 (예: 123.456.789.0 또는 server.example.com)
        # - SERVER_USER: SSH 사용자명 (예: ubuntu, root, ec2-user)
        # - SERVER_SSH_KEY: SSH 개인키 전체 내용
        # - SERVER_DEPLOY_PATH: docker-compose.yml이 있는 경로 (예: /home/ubuntu/app 또는 /opt/nimda-con)

# 자동 실행 작업 정리
# 1. 코드 가져오기
# 2. Java 17 설치
# 3. Maven 빌드 -> JAR 파일 생성 
# 4. 테스트 실행
# 5. JAR 파일 저장
# 6. Docker 이미지 빌드
# 7. Docker Hub 로그인
# 8. Docker Hub에 이미지 푸시
# 9. 서버에 SSH 접속
# 10. docker-compose pull & up (자동 배포) 